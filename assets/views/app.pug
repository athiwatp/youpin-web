extends layouts/layout

append content

  #page-app
    #feed.tab-bar-view
      page-feed
    #search.tab-bar-view
      page-feed
    //- #noti.tab-bar-view
    //-   .container
    //-     h4 ข้อความ
    //- #account.tab-bar-view
    //-   .container
    //-     h4 โปรไฟล์

    page-report(target='#report-btn')

    page-pin

prepend footer

  footer.tab-bar
    ul.tabs
      li.tab.col.s3
        a(href='#feed')
          i.icon.material-icons home
      li.tab.col.s3
        a#report-btn(href='#report')
          img(src=site_url('/public/image/marker-s.png'))
      li.tab.col.s3
        a(href='#search')
          i.icon.material-icons search
      //- li.tab.col.s3
      //-   a(href='#noti')
      //-     i.icon.material-icons notifications
      //- li.tab.col.s3
      //-   a(href='#account')
      //-     i.icon.material-icons face

append app_script
  script.
    // Route: #report
    app.route('report', function(id, action, qs, hash) {
      // hide all tab views
      $('#page-app .tab-bar-view').hide();
      $('.tabs > .tab > a').removeClass('active');

      app.get('page-report').showReportView();
    });

    // Route: #feed
    app.route('feed', function(id, action, qs, hash) {
      $('.tab-bar-view').hide();
      $('#feed').show();
      $.ajax({
        url: util.site_url('/pins?limit=100', app.get('service.api.url'))
      })
      .done(function(data) {
        var pins = _.map(data.pin_info, function(pin, key) { return parser.pin(pin, null, key); });
        pins.reverse();
        app.open('page-feed', '#feed', { title: 'พินล่าสุด', pins: pins });
      });
    });

    // Route: #search
    app.route('search', function(id, action, qs, hash) {
      $('.tab-bar-view').hide();
      $('#search').show();
      $.ajax({
        url: util.site_url('/api/feed')
      })
      .done(function(data) {
        var pins = data;
        app.open('page-feed', '#search', { title: 'ค้นหาพิน', pins: pins });
      });
    });

    // Route: #pins/:id
    app.route('pins', function(id, action, qs, hash) {
      if (!id) {
        app.goto('feed', true);
        return;
      }

      $.ajax({
        url: qs.mock ? util.site_url('/api/pin/' + id) : util.site_url('/pins/' + id, app.get('service.api.url'))
      })
      .done(function(data) {
        var pin;
        if (qs.mock) {
          pin = data;
        } else {
          pin = parser.pin(_.get(data, 'pin_info'), _.get(data, 'location.l'));
        }
        app.open('page-pin', pin);
      });
    });

    app.start();

    var pageReport = riot.mount('page-report')[0];
    app.set('page-report', pageReport);

  script.
    $(document).ready(function(){
      $('ul.tabs')
      .tabs()
      .on('click', 'a', function(e) {
        location.href = e.currentTarget.href;
      });

      $('#report-btn').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    if (!location.hash) {
      app.goto('feed', true);
    }
