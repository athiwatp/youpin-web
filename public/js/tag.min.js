"use strict";riot.tag2("map-box",'<div class="map-box-container" id="{id}-container"> <div class="map-box-widget" id="{id}"></div> </div>','map-box .map-box-container,[riot-tag="map-box"] .map-box-container,[data-is="map-box"] .map-box-container{ position: relative; width: 100%; height: 400px; } map-box .map-box-container .map-box-widget,[riot-tag="map-box"] .map-box-container .map-box-widget,[data-is="map-box"] .map-box-container .map-box-widget{ position: absolute; top: 0; bottom: 0; left: 0; right: 0; } map-box .leaflet-map-pane,[riot-tag="map-box"] .leaflet-map-pane,[data-is="map-box"] .leaflet-map-pane{ z-index: 2 !important; } map-box .leaflet-google-layer,[riot-tag="map-box"] .leaflet-google-layer,[data-is="map-box"] .leaflet-google-layer{ z-index: 1 !important; }',"",function(i){function a(){o.map&&t(),o.map=L.map(o.id,o.map_options),o.map.setView(o.center),o.map.setZoom(+o.map_options.zoom||17);var i=new L.Google("ROADMAP");o.map.addLayer(i)}function e(){o.markers=_.map(o.markers_center,function(i){return L.marker(i,{icon:o.YPIcon,interactive:!1,keyboard:!1,riseOnHover:!0}).addTo(o.map)});var i=new L.LatLngBounds(o.markers_center),a=i.getNorthEast();i.extend([a.lat,a.lng+.002]),o.map.fitBounds(i)}function t(){o.map&&(o.map.remove(),delete o.map)}var o=this;o.id="map-box-"+util.uniqueId();var n=/^options/i;o.map=null,o.map_options={zoom:16,fadeAnimation:!1,zoomAnimation:!1,markerZoomAnimation:!1},_.forEach(i,function(i,a){if(n.test(a)){var e=_.camelCase(a.replace(n,""));if(!e)return;"false"===i?o.map_options[e]=!1:"true"===i?o.map_options[e]=!0:o.map_options[e]=i}}),o.center={lat:13.7304311,lng:100.5696901},o.markers=[],o.markers_center=i.markers_center||[],o.YPIcon=L.icon({iconUrl:util.site_url("/public/image/marker-m.png"),iconSize:[32,51],iconAnchor:[16,48],popupAnchor:[0,-51]}),o.on("mount",function(){a(),e()}),o.on("unmount",function(){}),o.on("update",function(){}),o.on("updated",function(){})}),riot.tag2("page-feed",'<div id="page-feed"> <div class="container no-padding-s"> <h4 class="center" if="{title}">{title}</h4> <div class="row"> <div class="col s12 m6 l4" each="{pin in pins}"> <div class="card hover-card"><a class="card-image" href="#pins/{pin.id}{pin.mock ? &quot;?mock=1&quot; : &quot;&quot;}" riot-style="background-image: url({pin.photos &amp;&amp; pin.photos.length &gt; 0 ? pin.photos[0] : util.site_url(&quot;/public/image/pin_photo.png&quot;)})"></a> <div class="card-content"> <div class="card-description"> <div class="card-author"><a href="#user/{pin.owner}">@{pin.owner}</a></div> <div class="card-text">{pin.detail}</div> <div class="tag-list" if="{pin.tags &amp;&amp; pin.tags.length &gt; 0}"><a class="tag-item" each="{tag in pin.tags}" href="#tag/{tag}">{tag}</a></div> <div class="card-area" if="{pin.neighborhood}">ย่าน{pin.neighborhood}</div> </div> <div class="card-stat"> <div class="meta meta-like left">เห็นด้วย {pin.voters.length} คน</div> <div class="meta meta-comment left"><i class="icon material-icons tiny">chat_bubble_outline</i>ความเห็น {pin.comments.length}</div> </div> <div class="card-meta"> <div class="meta meta-time right">{moment(pin.created_time, [\'x\', \'M/D/YYYY, h:mm A\']).fromNow()}</div> <div class="meta meta-status left" data-status="{pin.status}">{pin.status}</div> </div> </div> </div> </div> </div> </div> </div>',"","",function(i){var a=this;a.title=i.title,a.pins=i.pins||[],a.on("mount",function(){})}),riot.tag2("page-pin",'<div id="page-pin"> <div class="map-container"> <map-box options-scroll-wheel-zoom="false" options-tap="false" options-keyboard="false"></map-box> </div> <div class="fluid-container no-padding-s"> <div class="row"> <div class="col s12 m6 offset-m6"> <div class="spacing"></div> <div class="card"> <div class="card-image responsive"> <div class="slider-container"> <div class="image-slider" id="photo-slider"> <div class="slider-item" each="{photo in pin.photos}"> <div class="image-item"> <div class="image" riot-style="background-image: url(&quot;{util.site_url(photo)}&quot;)"></div> </div> </div> </div> </div> </div> <div class="card-content"> <div class="pin-content"> <div class="card-description"> <div class="card-author"><a href="#user/{pin.owner}">@{pin.owner}</a></div> <div class="card-text">{pin.detail}</div> <div class="tag-list" if="{pin.tags &amp;&amp; pin.tags.length &gt; 0}"><a class="tag-item" each="{tag in pin.tags}" href="#tag/{tag}">{tag}</a></div> <div class="card-area" if="{pin.neighborhood}">ย่าน{pin.neighborhood}</div> </div> <div class="card-stat"> <div class="meta meta-like left">เห็นด้วย {pin.voters.length} คน</div> <div class="meta meta-comment left"><i class="icon material-icons tiny">chat_bubble_outline</i>ความเห็น {pin.comments.length}</div> </div> <div class="card-meta"> <div class="meta meta-time right">{moment(pin.created_time, [\'x\', \'M/D/YYYY, h:mm A\']).fromNow()}</div> <div class="meta meta-status left" data-status="{pin.status}">{pin.status}</div> </div> </div> <div if="{pin.comments &amp;&amp; pin.comments.length &gt; 0}"> <div class="divider"></div> <h5 class="section-name">ความคิดเห็น</h5> <div class="comment-list"> <div class="comment-item" each="{comment in pin.comments}"> <div class="card-description"> <div class="card-author"><a href="#user/{comment.commented_by}">@{comment.commented_by}</a></div> <div class="card-text">{comment.detail}</div> <div class="tag-list" if="{comment.tags &amp;&amp; comment.tags.length &gt; 0}"><a class="tag-item" each="{tag in comment.tags}" href="#tag/{tag}">{tag}</a></div> </div> <div class="card-stat"> <div class="meta meta-like left"><i class="icon material-icons tiny">person</i>{comment.voter.length} คน</div> </div> </div> </div> </div> </div> </div> </div> </div> </div> <div class="spacing-large"></div> </div>',"","",function(i){function a(){t.slider&&e(),t.$slider=$(t.root).find("#photo-slider"),t.$slider.on("init reinit",function(i){}).on("setPosition",function(i,a){}).slick({infinite:!0,speed:400,fade:t.fade,autoplay:!1,autoplaySpeed:t.autoplay_speed,accessibility:!1,cssEase:"ease-in"}),t.slider=!0}function e(){t.slider&&(t.$slider.slick("unslick"),t.slider=!1)}var t=this;t.pin=i,t.slider=!1,t.on("mount",function(){riot.mount("#page-pin map-box","map-box",{markers_center:[t.pin.location]})}),t.on("updated",function(){a()})}),riot.tag2("page-report",'<div class="modal bottom-sheet full-sheet" id="report-input-modal"> <div class="modal-header"> <nav> <ul class="left"> <li><a class="modal-action modal-close" href="#!">ยกเลิก</a></li> </ul> <div class="center"><a class="brand-logo" href="#"></a> <div class="modal-title">ใส่ข้อมูล</div> </div> <ul class="right"> <li><a href="#!" onclick="{clickSubmitReport}">ปักพิน</a></li> </ul> </nav> </div> <div class="modal-content"> <div class="container no-padding-s"> <div class="row"> <div class="col s12 m6 offset-m3 l4 offset-l4"> <form id="report-form"> <input type="hidden" name="location[]:number" value="{location.lat}"> <input type="hidden" name="location[]:number" value="{location.lng}"> <input each="{photo in photos}" type="hidden" name="photos[]" value="{photo.url}"> <input type="hidden" name="status" value="open"> <input type="hidden" name="owner" value="youpin"> <input type="hidden" name="level" value="normal"> <input type="hidden" name="neighborhood" value="{neighborhood}"> <div class="card"> <div class="card-image responsive"> <div class="slider-container"> <div class="image-slider" id="photo-slider"> <div class="slider-item" each="{photo, i in photos}" data-i="{i}"><a class="image-item" data-i="{i}" href="#!" onclick="{clickPhoto}"> <div class="image" riot-style="background-image: url(&quot;{util.site_url(photo.url)}&quot;)"></div></a></div> </div> </div> </div> <div class="card-content"> <div class="input-field"><i class="icon material-icons prefix">chat_bubble_outline</i> <input class="validate" type="text" name="detail" placeholder="ตั้งชื่อพิน" value="{detail}"> </div> <div class="input-field"><i class="icon material-icons prefix {location.lat ? &quot;active&quot; : &quot;&quot;}">place</i><a class="location-input input" href="#" onclick="{clickLocation}">{location_text}</a></div> <div class="input-field"><i class="icon material-icons prefix">inbox</i> <input class="validate" type="text" name="categories" placeholder="หมวด" value="{categories}"> </div> </div> </div> </form> </div> </div> </div> </div> </div> <div class="modal bottom-sheet full-sheet" id="report-photo-modal"> <div class="modal-header"> <nav> <ul class="left"> <li><a class="modal-action modal-close" href="#!"><i class="icon material-icons">arrow_back</i></a></li> </ul> <div class="center"><a class="brand-logo" href="#"></a> <div class="modal-title">ใส่ภาพถ่าย</div> </div> <ul class="right"></ul> </nav> </div> <div class="modal-content"> <div class="container no-padding-s"> <div class="row card-list"> <div class="col s12 m6 offset-m3 l4 offset-l4" each="{photo, i in photos}"> <div class="card" data-i="{i}"> <div class="card-image responsive"><img riot-src="{util.site_url(photo.url)}"></div> <div class="card-content"> <div class="input-field"> <input class="validate" type="text" name="photo[{i}][text]" value="{photo.text}" placeholder="ใส่คำอธิบาย" data-i="{i}" onchange="{changePhotoText}"> </div> </div> </div> </div> <div class="col s12 m6 offset-m3 l4 offset-l4"> <div class="card"> <div class="card-image responsive"> <div class="drop-image-preview hide"></div> <div class="card-title center drop-image valign-wrapper" name="dropzone-el"><i class="icon material-icons">photo_camera</i>เพิ่มรูป</div> </div> </div> </div> </div> </div> </div> </div> <div class="modal bottom-sheet full-sheet" id="report-map-modal"> <div class="modal-header"> <nav> <ul class="left"> <li><a class="modal-action modal-close" href="#!"><i class="icon material-icons">check</i></a></li> </ul> <div class="center"><a class="brand-logo" href="#"></a> <div class="modal-title">ใส่ตำแหน่ง</div> </div> <ul class="right"> <li><a href="#!" onclick="{setMapLocationByGeolocation}"><i class="icon material-icons">gps_fixed</i></a></li> </ul> </nav> </div> <div class="modal-content no-padding"> <div class="input-location-map" id="input-location-map"></div> </div> </div> <div class="modal" id="report-uploading-modal"> <div class="modal-content"> <div class="progress"> <div class="indeterminate"></div> </div> <h4 class="center">กำลังอัพโหลด</h4> </div> </div> <div class="modal" id="report-saving-modal"> <div class="modal-content"> <div class="progress"> <div class="indeterminate"></div> </div> <h4 class="center">กำลังพิน</h4> </div> </div>','page-report .input-location-map,[riot-tag="page-report"] .input-location-map,[data-is="page-report"] .input-location-map{ position: absolute; top: 0; bottom: 0; left: 0; right: 0; } page-report .leaflet-map-pane,[riot-tag="page-report"] .leaflet-map-pane,[data-is="page-report"] .leaflet-map-pane{ z-index: 2 !important; } page-report .leaflet-google-layer,[riot-tag="page-report"] .leaflet-google-layer,[data-is="page-report"] .leaflet-google-layer{ z-index: 1 !important; }',"",function(i){function a(){d(),s(),v.target=i.target,v.detail="",v.categories="",v.photos=[],v.map=null,v.location=null,$(v.root).find('input[name="detail"]').val(""),$(v.root).find('input[name="categories"]').val(""),v.update()}function e(){v.dropzone||(v.dropzone=new Dropzone(v["dropzone-el"],{url:util.site_url("/api/image"),method:"POST",acceptedFiles:"image/*",paramName:"image",maxFilesize:5,previewsContainer:".drop-image-preview",previewTemplate:'<div class="dz-preview-template" style="display: none;"></div>',dictDefaultMessage:"",clickable:[$(v.target)[0],v["dropzone-el"]],uploadMultiple:!0,fallback:function(){$(v.root).find(".dropzone").hide(),$(v.root).find(".dropzone-error").show()}}),v.dropzone.on("addedfile",function(i){}).on("sendingmultiple",function(i,a,e){t()}).on("successmultiple",function(i,a){for(var e=0;e<i.length;e++){var t=a[e];_.assignIn(t,{width:i[e].width,height:i[e].height}),v.photos.push(t)}}).on("errormultiple",function(i){console.error("error:",arguments)}).on("completemultiple",function(i){o()}))}function t(){$("#report-uploading-modal").openModal({dismissible:!1})}function o(){$("#report-uploading-modal").closeModal();var i=$(v["report-input-modal"]),e=$(v["report-photo-modal"]);i.hasClass("open")?e.openModal():i.openModal({ready:function(){},complete:function(){a()}}),v.update(),n()}function n(){v.slider&&s(),v.$slider=$(v.root).find("#photo-slider"),v.$slider.on("init reinit",function(i){}).on("setPosition",function(i,a){}).slick({infinite:!0,speed:400,fade:v.fade,autoplay:!1,autoplaySpeed:v.autoplay_speed,accessibility:!1,cssEase:"ease-in"}),v.slider=!0}function s(){v.slider&&(v.$slider.slick("unslick"),v.slider=!1)}function l(){v.map&&d(),v.map=L.map(v.map_id),v.map.locate({setView:!0,maxZoom:16}),v.map.on("locationfound",function(i){c(v.map.getCenter())}),v.map.on("locationerror",function(i){console.error(i.message),v.map.setView([13.7302295,100.5724075],16)});var i=new L.Google("ROADMAP");v.map.addLayer(i),v.map_marker=L.marker([v.DEFAULT_LOCATION.lat,v.DEFAULT_LOCATION.lng],{icon:v.YPIcon}).bindPopup("ที่นี่มีหลุมบ่อ น้ำท่วมขังบ่อย ส่งกลิ่นเหม็นทุกเย็นเลย").addTo(v.map),v.map.on("drag",_.throttle(function(){c(v.map.getCenter())},100)),v.map.on("dragend",function(i){c(v.map.getCenter())})}function d(){v.map&&(v.map.remove(),delete v.map)}function c(i){v.location=i,v.map_marker.setLatLng(i),v.update()}function r(i){$("#report-photo-modal").openModal()}function p(){$("#report-saving-modal").openModal({dismissible:!1});var i=$("#report-form").serializeJSON();i.categories=_.map(i.categories&&"string"==typeof i.categories?i.categories.split(","):[],function(i){return _.trim(i)}),i.tags=util.extract_tags(i.detail),i.created_time=Date.now(),i.updated_time=i.created_time,$.ajax({url:util.site_url("/pins",app.get("service.api.url")),method:"post",headers:{Authorization:"Basic "+app.get("service.api.hash_key")},beforeSend:function(i){i.setRequestHeader("Content-Type","application/json"),i.setRequestHeader("Accept","application/json")},dataType:"json",data:JSON.stringify(i)}).done(function(i){m(),app["goto"]("pins/"+i.name)}).fail(function(i){console.error("error:",err)})}function m(){a(),$("#report-saving-modal").closeModal(),$("#report-input-modal").closeModal()}var v=this;v.dropzone=null,v.slider=!1,v.detail="",v.categories="",v.photos=[],v.target=i.target,v.map=null,v.map_id="input-location-map",v.location={lat:"",lng:""},v.neighborhood="สีลม",v.DEFAULT_LOCATION={lat:13.7302295,lng:100.5724075},v.YPIcon=L.icon({iconUrl:util.site_url("/public/image/marker-m.png"),iconSize:[32,51],iconAnchor:[16,48],popupAnchor:[0,-51]}),v.on("update",function(){v.location_text=v.location&&"number"==typeof v.location.lat?"ปักพินแล้ว":"เลือกตำแหน่ง"}),v.on("mount",function(){}),v.on("unmount",function(){}),v.on("updated",function(){e()}),v.clickPhoto=function(i){i.preventDefault(),i.stopPropagation(),r()},v.changePhotoText=function(i){var a=+$(i.target).attr("data-i");v.photos[a].text=i.value},v.clickLocation=function(i){i.preventDefault(),i.stopPropagation(),$("#report-map-modal").openModal({ready:function(){v.map||l()}})},v.setMapLocationByGeolocation=function(i){i.preventDefault(),i.stopPropagation(),v.map&&v.map.locate({setView:!0,maxZoom:16})},v.clickSubmitReport=function(i){i.preventDefault(),i.stopPropagation(),p()}});