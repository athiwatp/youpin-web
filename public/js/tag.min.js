"use strict";riot.tag2("map-box",'<div class="map-box-container" id="{id}-container"> <div class="map-box-widget" id="{id}"></div> </div>','map-box .map-box-container,[riot-tag="map-box"] .map-box-container,[data-is="map-box"] .map-box-container{ position: relative; width: 100%; height: 400px; } map-box .map-box-container .map-box-widget,[riot-tag="map-box"] .map-box-container .map-box-widget,[data-is="map-box"] .map-box-container .map-box-widget{ position: absolute; top: 0; bottom: 0; left: 0; right: 0; } map-box .leaflet-map-pane,[riot-tag="map-box"] .leaflet-map-pane,[data-is="map-box"] .leaflet-map-pane{ z-index: 2 !important; } map-box .leaflet-google-layer,[riot-tag="map-box"] .leaflet-google-layer,[data-is="map-box"] .leaflet-google-layer{ z-index: 1 !important; }',"",function(a){function o(){t.map&&e(),t.map=L.map(t.id,t.map_options),t.map.setView(t.center),t.map.setZoom(17);var a=new L.Google("ROADMAP");t.map.addLayer(a)}function i(){t.markers=_.map(t.markers_center,function(a){return L.marker(a,{icon:t.YPIcon,interactive:!1,keyboard:!1,riseOnHover:!0}).addTo(t.map)})}function e(){t.map&&(t.map.remove(),delete t.map)}var t=this;t.id="map-box-"+util.uniqueId();var l=/^options/i;t.map=null,t.map_options={zoom:16},_.forEach(a,function(a,o){if(l.test(o)){var i=_.camelCase(o.replace(l,""));if(!i)return;"false"===a?t.map_options[i]=!1:"true"===a?t.map_options[i]=!0:t.map_options[i]=a}}),t.center={lat:13.7304311,lng:100.5696901},t.markers=[],t.markers_center=[{lat:13.729518,lng:100.571857},{lat:13.731152,lng:100.568566},{lat:13.7284191,lng:100.5704483},{lat:13.7297639,lng:100.570291},{lat:13.7302163,lng:100.5702538},{lat:13.73,lng:100.566672},{lat:13.730206,lng:100.569767},{lat:13.7314005,lng:100.570862},{lat:13.728786,lng:100.568968},{lat:13.7297649,lng:100.5709659}],t.YPIcon=L.icon({iconUrl:util.site_url("/public/image/marker-m.png"),iconSize:[32,51],iconAnchor:[16,48],popupAnchor:[0,-51]}),t.on("mount",function(){o(),i()}),t.on("unmount",function(){}),t.on("update",function(){}),t.on("updated",function(){})}),riot.tag2("page-report",'<div class="modal bottom-sheet full-sheet" id="report-input-modal"> <div class="modal-header"> <nav> <ul class="left"> <li><a class="modal-action modal-close" href="#!">ยกเลิก</a></li> </ul> <div class="center"><a class="brand-logo" href="#"></a> <div class="modal-title">ใส่ข้อมูล</div> </div> <ul class="right"> <li><a href="#!" onclick="{clickSubmitReport}">ปักพิน</a></li> </ul> </nav> </div> <div class="modal-content no-padding"> <form> <div class="card"> <div class="card-image"> <div class="slider-container"> <div class="image-slider" id="photo-slider"> <div class="slider-item" each="{photo, i in photos}" data-i="{i}"><a class="image-item" data-i="{i}" href="#!" onclick="{clickPhoto}"> <div class="image" riot-style="background-image: url(&quot;{util.site_url(photo.url)}&quot;)"></div></a></div> </div> </div> </div> <div class="card-content"> <div class="input-field"><i class="icon material-icons prefix">chat_bubble_outline</i> <input class="validate" type="text" name="name" placeholder="ตั้งชื่อพิน"> </div> <div class="input-field"><i class="icon material-icons prefix">place</i> <input class="validate" type="text" name="location" placeholder="ใส่ตำแหน่ง" value="{location_text}" readonly onfocus="{clickLocation}"> </div> <div class="input-field"><i class="icon material-icons prefix">style</i> <input class="validate" type="text" name="category" placeholder="หมวด"> </div> <div class="input-field"><i class="icon material-icons prefix">local_offer</i> <input class="validate" type="text" name="tag" placeholder="แท็ก"> </div> </div> </div> </form> </div> </div> <div class="modal bottom-sheet full-sheet" id="report-photo-modal"> <div class="modal-header"> <nav> <ul class="left"> <li><a class="modal-action modal-close" href="#!"><i class="icon material-icons">arrow_back</i></a></li> </ul> <div class="center"><a class="brand-logo" href="#"></a> <div class="modal-title">ใส่ภาพถ่าย</div> </div> </nav> </div> <div class="modal-content no-padding"> <div class="row card-list"> <div class="col s12 m6 l4" each="{photo, i in photos}"> <div class="card" data-i="{i}"> <div class="card-image"><img riot-src="{util.site_url(photo.url)}"></div> <div class="card-content"> <div class="input-field"> <input class="validate" type="text" name="photo[{i}][text]" value="{photo.text}" placeholder="ใส่คำอธิบาย" data-i="{i}" onchange="{changePhotoText}"> </div> </div> </div> </div> <div class="col s12 m6 l4"> <div class="card"> <div class="card-image"> <div class="drop-image-preview hide"></div> <div class="card-title center drop-image valign-wrapper" name="dropzone-el"><i class="icon material-icons">photo_camera</i>เพิ่มรูป</div> </div> </div> </div> </div> </div> </div> <div class="modal bottom-sheet full-sheet" id="report-map-modal"> <div class="modal-header"> <nav> <ul class="left"> <li><a class="modal-action modal-close" href="#!"><i class="icon material-icons">check</i></a></li> </ul> <div class="center"><a class="brand-logo" href="#"></a> <div class="modal-title">ใส่ตำแหน่ง</div> </div> <ul class="right"> <li><a href="#!" onclick="{setMapLocationByGeolocation}"><i class="icon material-icons">gps_fixed</i></a></li> </ul> </nav> </div> <div class="modal-content no-padding"> <div class="input-location-map" id="input-location-map"></div> </div> </div> <div class="modal" id="report-uploading-modal"> <div class="modal-content"> <div class="progress"> <div class="indeterminate"></div> </div> <h4 class="center">กำลังอัพโหลด</h4> </div> </div> <div class="modal" id="report-saving-modal"> <div class="modal-content"> <div class="progress"> <div class="indeterminate"></div> </div> <h4 class="center">กำลังพิน</h4> </div> </div>','page-report .input-location-map,[riot-tag="page-report"] .input-location-map,[data-is="page-report"] .input-location-map{ position: absolute; top: 0; bottom: 0; left: 0; right: 0; } page-report .leaflet-map-pane,[riot-tag="page-report"] .leaflet-map-pane,[data-is="page-report"] .leaflet-map-pane{ z-index: 2 !important; } page-report .leaflet-google-layer,[riot-tag="page-report"] .leaflet-google-layer,[data-is="page-report"] .leaflet-google-layer{ z-index: 1 !important; }',"",function(a){function o(){r(),n(),u.photos=[],u.target=a.target,u.map=null,u.location=null,u.update()}function i(){u.dropzone||(u.dropzone=new Dropzone(u["dropzone-el"],{url:util.site_url("/api/image"),method:"POST",acceptedFiles:"image/*",paramName:"image",maxFilesize:5,previewsContainer:".drop-image-preview",previewTemplate:'<div class="dz-preview-template" style="display: none;"></div>',dictDefaultMessage:"",clickable:[$(u.target)[0],u["dropzone-el"]],uploadMultiple:!0,fallback:function(){$(u.root).find(".dropzone").hide(),$(u.root).find(".dropzone-error").show()}}),u.dropzone.on("addedfile",function(a){}).on("sendingmultiple",function(a,o,i){e()}).on("successmultiple",function(a,o){for(var i=0;i<a.length;i++){var e=o[i];_.assignIn(e,{width:a[i].width,height:a[i].height}),u.photos.push(e)}}).on("errormultiple",function(a){console.error("error:",arguments)}).on("completemultiple",function(a){t()}))}function e(){$("#report-uploading-modal").openModal({dismissible:!1})}function t(){$("#report-uploading-modal").closeModal();var a=$(u["report-input-modal"]),i=$(u["report-photo-modal"]);a.hasClass("open")?i.openModal():a.openModal({ready:function(){},complete:function(){o()}}),u.update(),l()}function l(){u.slider&&n(),u.$slider=$(u.root).find("#photo-slider"),u.$slider.on("init reinit",function(a){}).on("setPosition",function(a,o){}).slick({infinite:!0,speed:400,fade:u.fade,autoplay:!1,autoplaySpeed:u.autoplay_speed,accessibility:!1,cssEase:"ease-in"}),u.slider=!0}function n(){u.slider&&(u.$slider.slick("unslick"),u.slider=!1)}function d(){u.map&&r(),u.map=L.map(u.map_id),u.map.locate({setView:!0,maxZoom:16}),u.map.on("locationfound",function(a){s(u.map.getCenter())}),u.map.on("locationerror",function(a){console.error(a.message),u.map.setView([13.7302295,100.5724075],16)});var a=new L.Google("ROADMAP");u.map.addLayer(a),u.map_marker=L.marker([u.DEFAULT_LOCATION.lat,u.DEFAULT_LOCATION.lng],{icon:u.YPIcon}).bindPopup("ที่นี่มีหลุมบ่อ น้ำท่วมขังบ่อย ส่งกลิ่นเหม็นทุกเย็นเลย").addTo(u.map),u.map.on("drag",_.throttle(function(){s(u.map.getCenter())},100)),u.map.on("dragend",function(a){s(u.map.getCenter())})}function r(){u.map&&(u.map.remove(),delete u.map)}function s(a){u.location=a,u.map_marker.setLatLng(a),u.update()}function c(a){$("#report-photo-modal").openModal()}function p(){$("#report-saving-modal").openModal({dismissible:!1}),setTimeout(m,3e3)}function m(){$("#report-saving-modal").closeModal(),$("#report-input-modal").closeModal()}var u=this;u.dropzone=null,u.slider=!1,u.photos=[],u.target=a.target,u.map=null,u.map_id="input-location-map",u.location=null,u.DEFAULT_LOCATION={lat:13.7302295,lng:100.5724075},u.YPIcon=L.icon({iconUrl:util.site_url("/public/image/marker-m.png"),iconSize:[32,51],iconAnchor:[16,48],popupAnchor:[0,-51]}),u.on("update",function(){u.location_text=u.location?u.location.lat+","+u.location.lng:""}),u.on("mount",function(){}),u.on("unmount",function(){}),u.on("updated",function(){i()}),u.clickPhoto=function(a){a.preventDefault(),a.stopPropagation(),c()},u.changePhotoText=function(a){var o=+$(a.target).attr("data-i");u.photos[o].text=a.value},u.clickLocation=function(a){a.preventDefault(),a.stopPropagation(),$("#report-map-modal").openModal({ready:function(){u.map||d()}})},u.setMapLocationByGeolocation=function(a){a.preventDefault(),a.stopPropagation(),u.map&&u.map.locate({setView:!0,maxZoom:16})},u.clickSubmitReport=function(a){a.preventDefault(),a.stopPropagation(),p()}});